name: Weekly Update

on:
  schedule:
    - cron: 0 0 * * 6
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: julia-actions/setup-julia@v1
        with:
          version: 1.6
      - uses: julia-actions/cache@v1
      - name: "Update Manifest.toml files"
        run: find tutorials/ -type f -name Manifest.toml -exec julia --color=yes -e "using Pkg; Pkg.activate(dirname(ARGS[1])); Pkg.instantiate(); Pkg.update()'" {} \;
      - run: git status
      - name: "Upload Manifest.toml files"
        uses: actions/upload-artifact@v2
        with:
          name: manifest_files
          path: tutorials/**/Manifest.toml
          if-no-files-found: error
  pr:
    needs: update
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: "Download Manifest.toml files"
        uses: actions/download-artifact@v3
        with:
          name: manifest_files
          path: /tmp/manifest_files
      - name: "Update existing Manifest.toml files"
        run: rsync -avc /tmp/manifest_files/tutorials .
      - name: "Remove download"
        run: rm -rf /tmp/manifest_files
      - run: git status
      - uses: peter-evans/create-pull-request@v4
        with:
          delete-branch: true
          branch: 'gh/update_manifests'
          commit-message: 'Update manifest files'
          title: '[UpdateManifests.yml] Update manifest files'
          body: ''
